# 行业选择与组合支持平台（A股+H股，中周期长多）

产品设计 v1.1.final（母版，含专家终审修订）

读者：产品、研发、数据、QA、运维、合规
 运行形态：边缘/本地部署优先（Jetson Orin AGX/ARM64 单机），受控出网
 版本基线：提交包 v1.1 + v1.1.1 全量合并 + 专家终审修订（5.7）

------

## 0. 综述与结论

- 本母版整合 v1.1 与 v1.1.1，并全面采纳专家终审（5.7）的修订意见。
- 核心理念保持：四闸门方法论、证据链、快照/时间旅行、RBAC/不可破坏审计。
- 关键新增/修订（最终定稿）：
  - 告警按类型节流优先级：`by_type` 高于全局回退；趋势以“收盘后均线交叉确认”；回撤采用 latch 锁存与明确恢复条件。
  - H 股参与率默认 0.08；Liquidity API 回显 `usedParticipationRate/usedExitDays/freeFloatUtilizationPct/notes[]`。
  - 固化置信度公式与阈值、估值分位回退链、停牌样本参与 DMA 的口径；H 股 Board Lot 拦截。
  - API 统一：`Idempotency-Key`、标准错误码、`asOf` 查询、`X-Snapshot-Ts` 回显；OpenAPI 摘要显性列示回显字段。
  - 配置新增默认：`app.timezone=Asia/Shanghai`，`app.currencyDefault=CNY`。
  - 证据生命周期与哈希：MinIO 生命周期（热 180 天、冷 5 年），哈希算法 `SHA-256`。
  - 运维 KPI：EOD 批任务 T+30 分钟完成率（95 分位）；Prometheus 增加节流与 EOD 观测指标；CI 配置对比器防红线漂移。

------

## 1. 目标、范围、非目标、成功指标（PDD）

### 1.1 目标

- 建立“评分 → 闸门 → 建仓 → 监控 → 复盘”的可审计闭环，固化研究与执行纪律。
- 在本地/离线受限环境下，提供稳定、受控合规的数据与运维能力。

### 1.2 范围

- MVP：行业/个股评分与快照、备忘录、容量/流动性校验、组合看板、告警中心、RBAC/审计。
- v1.1：历史轨迹、估值分位计算器、再平衡建议、数据质量看板、全文检索。
- v1.2（规划）：指数/CA 历史快照、回测一致、离线数据包增强、一致预期方向/广度（开关）。

### 1.3 非目标（MVP）

- 不包含自动交易/对冲；不直连付费数据（仅预留连接器与导入口）。

### 1.4 成功指标（验收）

- 业务：全链路一次通过率 ≥ 95%；纪律达标率月报。
- 性能：评分请求 P99 ≤ 200ms；100 标的组合构建 ≤ 2s。
- 可用性：业务时段 ≥ 99.5%；重大动作具备审计。
- 数据：关键字段覆盖率 ≥ 95%；延迟监控覆盖 ≥ 90%。
- 新增：按类型节流 100% 生效；回撤锁存/恢复一致性 100%；Liquidity 回显一致性 100%；EOD T+30 分钟完成率 ≥ 95%。

------

## 2. 关键流程与状态机

### 2.1 端到端流程

评分（Industry/Equity） → 闸门校验（Industry/Company/Valuation/Execution） → 建仓计划（A/B/C 三段式） → 监控（事件/KPI/趋势/回撤断路器） → 月度复盘（纪律达标与审计报告）。

### 2.2 状态机

- 标的入池：Draft → Review → InPool → BuildPlan → Active → Watch → Exit
  - Draft→Review：证据 ≥ 2 且评分完整
  - Review→InPool：四闸门通过
  - Active→Watch：软阈/红旗触发
  - Watch→Exit：断路器动作或硬阈超限
- 告警处理：New → Acknowledged → InProgress → Resolved → Closed
  - 节流：按类型配置，列表显示“距下次可触发”
  - 回撤型：latch 锁存，满足恢复条件后自动解除
- 评分版本：Draft → Submitted → Approved → Superseded（不可破坏，旧版永存）

------

## 3. 信息架构与交互（IA/UX）

### 3.1 导航

- 顶栏：行业评分｜个股筛选｜备忘录｜组合｜告警｜设置
- 设置：参数与阈值｜数据源白名单｜RBAC 与审计｜导入/导出｜系统状态

### 3.2 页面线框（文字稿）

- 行业评分台：行业、Score(Ind)、P/E/M/R−、估值分位、拥挤度、入池状态、更新时间；右侧抽屉展示证据链与事件日历；支持批量 `gate/check`。
- 个股筛选：过滤（市值/ADV、Q/V/M/C/S、红旗、200DMA 状态、估值分位、PEG）；行操作（证据、流动性校验、加入建仓篮子）。
- 备忘录：论点｜三证据｜KPI 树｜风控与退出触发｜仓位建议；导出 Markdown/PDF。
- 组合看板：A/B/C 分层、目标/当前、现金、融资；容量校验与解释器；模拟模式。
- 告警中心：类型（事件/KPI/趋势/回撤）、严重度、状态、处理人、上次触发；列：距下次可触发、锁存状态（回撤）。
- 设置：参数/YAML 映射与来源提示；出网代理/UA/白名单；RBAC 矩阵；审计导出；系统健康（DB/Redis/队列滞后）。

### 3.3 交互强化

- 口径提示：悬浮显示 `unit/freq/isEstimate/sourceUrl/ingestTs/method`。
- 新鲜度与覆盖：`stale/partial/confidence` 显著可见。
- H 股 Board Lot 拦截：非整板时提示并给建议数量（就近取整）。

------

## 4. 数据与算法

### 4.1 数据字典（PIT）

- `IndustryScoreSnapshot`：`industryId, P, E, M, Rneg, score, ts, editor, method, asOf, source`
- `Equity`：`ticker, exchange, name, mktCap, freeFloat, adv20, boardLot, currency`
- `EquityScoreSnapshot`：`ticker, Q, V, M, C, S, Rneg, score, ts, editor, asOf, isPartial, isStale, confidence`
- `ValuationPercentileSnapshot`：`ticker, windowYears, percentile, asOf, method, isPartial`
- `EvidenceItem`：`entityType, entityId, type, url, source, ts, hash, note`
- `DecisionLog`（不可变链）：`id, user, action, payloadHash, prevHash, before, after, ts, requestId`
- `Alert`：`type, entityType, entityId, severity, rule, status, assignee, hits, ts`

### 4.2 评分与闸门

- 行业评分（100 分）
   ( Score^{Ind} = 0.35P + 0.25E + 0.25M + 0.15 \times (100 - R^{-}) )
   入池阈：(\ge 70)，核心候选：(\ge 75)
- 个股评分权重：Q(30)/V(20)/M(25)/C(15)/S(10)，红旗 (R^{-}) 扣分
   建仓阈：(\ge 70) 且估值分位 ≤ 70%（成长 ≤ 80%，(PEG \le 1.5)）
- 四闸门：行业｜公司｜估值｜执行（200DMA 在上，三段式 40/30/30）

### 4.3 动量、停牌与置信度

- 200DMA：交易日日终批量；盘中引用 T−1。
- 停牌样本参与声明：停牌期间采用“前值携带参与均线样本”，标注 `isStale=true`；停牌 > 20 个交易日，置信度权重下调。
- 置信度 (Conf \in [0,100])：
  - ( w_{cov} = \min(1, N_{obs}/1250) )（5 年×250）
  - ( w_{stale} = 1 )（≤5日）/ (0.8)（6–20日）/ (0.6)（>20日）
  - ( w_{src} \in {1.0, 0.9, 0.8} )（官方/授权/公开抓取）
  - ( Conf = 100 \times w_{cov} \times w_{stale} \times w_{src} )

### 4.4 估值分位回退链

P/E → EV/EBITDA → EV/Sales → 当日同子行业横截面 Z-Score。触发条件：NA 或覆盖不足；回退后 `isPartial=true` 并下调置信度。

### 4.5 流动性与容量

- 参与率 (r)：A 0.10、H 0.08（默认）
- 退出天数 (D)：核心 5、战术 3
- 底线公式：[ ADV_{min} \ge \frac{P_i}{r \times D} ]
- 绝对底线：A `ADV20≥3000万` 且 `换手≥0.5%`；H `ADV20≥2000万` 且 `换手≥0.3%`；自由流通占用 ≤ 2%。

------

## 5. 体系结构与接口

### 5.1 逻辑与部署架构（Edge 优先）

- 网关/鉴权：
  - Caddy/Nginx 终止 TLS，统一 `X-Request-ID` 注入；JWT Bearer 鉴权，支持短期令牌与刷新令牌。
  - RBAC 使用 Casbin（策略存 PostgreSQL），最小权限发放，按角色分离：`analyst | pm | compliance | admin`。
- 核心服务：
  - `Score`（行业/个股评分）、`Gatekeeper`（四闸门）、`Liquidity`（容量校验与回显）、`Portfolio`（构建/再平衡/断路器）、`Evidence`（证据入库/哈希/生命周期）、`Audit`（不可变链）、`Event&Alert`（事件汇聚与告警）。
- 数据与中间件：
  - PostgreSQL 16（OLTP+快照表）；Redis 7（缓存、Streams、Celery Broker/Backend）；MinIO（证据对象存储）；Meilisearch/Typesense（全文检索）。
- 批与调度：
  - APScheduler/Cron 负责 EOD 作业（200DMA、估值分位、快照固化、KPI 计算）；Celery 执行异步任务。
- 可观测性：
  - Prometheus+Grafana（指标），Loki+Promtail（日志），OpenTelemetry（追踪）。
- 边界策略：
  - 批与在线路径隔离；只读副本承压；写接口幂等（`Idempotency-Key`）；全链路 `X-Request-ID`。
  - Edge 设备（ARM64）以 Docker Compose 部署，`restart: unless-stopped`，系统级自拉起。

### 5.2 API 约定与错误码

- 通用约定：
  - 认证：`Authorization: Bearer <JWT>`
  - 时间旅行：查询参数 `?asOf=YYYY-MM-DD`（时区：`Asia/Shanghai`）
  - 快照回显：响应头 `X-Snapshot-Ts: <ISO-8601>`；请求追踪：`X-Request-ID`
  - 幂等：写接口可附 `Idempotency-Key`，冲突返回 `409`
  - 分页：`page, pageSize`；速率限制命中返回 `429`
- 错误码规范：
  - `400` 参数错误 ｜ `401/403` 鉴权/权限不足 ｜ `404` 目标不存在
  - `409` 幂等冲突 ｜ `422` 语义校验失败 ｜ `429` 节流命中 ｜ `503` 下游不可用
- 版本与内容类型：
  - Base URL：`/api`（OpenAPI: v1.1.1-final）；`application/json; charset=utf-8`

### 5.3 OpenAPI 摘要（关键端点与“回显字段”）

> 注：以下为精简摘要，完整以附录 OpenAPI 为准。已按专家终审建议显性列示“回显字段”，并补充请求体必填项示例。

```yaml
openapi: 3.0.3
info: { title: A+H Industry & Portfolio APIs, version: 1.1.1-final }
servers: [{ url: https://edge.local/api }]
components:
  securitySchemes:
    bearerAuth: { type: http, scheme: bearer, bearerFormat: JWT }
  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      schema: { type: string }
      description: Idempotency key for safely retrying POST
    AsOfDate:
      name: asOf
      in: query
      required: false
      schema: { type: string, format: date }
      description: Point-in-time snapshot query (timezone=Asia/Shanghai)

paths:
  /liquidity/check:
    post:
      security: [{ bearerAuth: [] }]
      parameters: [{ $ref: '#/components/parameters/IdempotencyKey' }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [ticker, targetPosition, currency, ADV20, turnover, freeFloatMktCap, r, D]
              properties:
                ticker: { type: string, example: "600519.SH" }
                targetPosition: { type: number, example: 70000 }
                currency: { type: string, enum: [CNY, HKD], example: "CNY" }
                ADV20: { type: number, example: 250000000 }
                turnover: { type: number, example: 0.006 }
                freeFloatMktCap: { type: number, example: 1.2e11 }
                r: { type: number, description: "Participation rate; defaults by market if omitted", example: 0.08 }
                D: { type: integer, description: "Exit days", example: 5 }
      responses:
        '200':
          description: Liquidity decision with echoes
          headers:
            X-Snapshot-Ts: { schema: { type: string }, description: "Snapshot timestamp (ISO-8601)" }
          content:
            application/json:
              schema:
                type: object
                properties:
                  advMin: { type: number }
                  absoluteFloorPass: { type: boolean }
                  freeFloatCapPass: { type: boolean }
                  usedParticipationRate: { type: number }   # 回显参与率
                  usedExitDays: { type: integer }            # 回显退出天数
                  freeFloatUtilizationPct: { type: number }  # 自由流通占用占比
                  notes: { type: array, items: { type: string } }
        '400': { description: Bad Request }
        '429': { description: Throttled }

  /portfolio/construct:
    post:
      security: [{ bearerAuth: [] }]
      parameters: [{ $ref: '#/components/parameters/IdempotencyKey' }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [capital, leverageMax, tiers, candidates]
              properties:
                capital: { type: number, example: 5000000 }
                leverageMax: { type: number, example: 1.1 }
                tiers:
                  type: array
                  items:
                    type: object
                    required: [name, targetPct]
                    properties:
                      name: { type: string, example: "A" }
                      targetPct: { type: array, items: { type: number }, example: [0.12, 0.15] }
                candidates:
                  type: array
                  items:
                    type: object
                    required: [ticker, tier, score]
                    properties:
                      ticker: { type: string, example: "0700.HK" }
                      tier: { type: string, example: "A" }
                      score: { type: number, example: 78.5 }
      responses:
        '200':
          description: Constructed positions and entry plan
          headers:
            X-Snapshot-Ts: { schema: { type: string }, description: "Snapshot timestamp (ISO-8601)" }
          content:
            application/json:
              schema:
                type: object
                properties:
                  positions: { type: array, items: { type: object } }
                  entryPlan:
                    type: array
                    items:
                      type: object
                      properties:
                        leg: { type: integer }       # 1/2/3
                        amount: { type: number }     # 默认币种 app.currencyDefault
                        condition: { type: string }  # e.g. ">=200DMA", "+/-1*ATR"
                  circuitBreaker:
                    type: object
                    properties:
                      level: { type: string, enum: [L0, L1, L2, L3] }
                      armed: { type: boolean }       # 是否布防
        '400': { description: Bad Request }
        '503': { description: Downstream Unavailable }
```

### 5.4 数据流与批处理（EOD）

- Ingest 层：行情/财报/公告/行业数据按白名单采集，打 `sourceUrl/ingestTs` 标签。
- EOD 作业（T+30 分钟 KPI，95 分位）：
  - 200DMA 计算 → 估值分位快照（5 年窗口）→ `isStale/isPartial/confidence` 更新 → 触发趋势型告警确认。
- 事件/告警流水：事件去重键 `{symbol}-{type}-{date}-{source}`，按类型节流聚合；drawdown 类型支持 `latch`。
- 快照固化：PIT 表记录 `asOf` 与 `X-Snapshot-Ts`；历史不可变更，仅追加更正记录。

### 5.5 安全与鉴权

- JWT：短期访问令牌（默认 15 分钟）+ 刷新令牌；签名算法 `RS256`。
- RBAC：Casbin 策略，细化到“资源/动作/域”，合规敏感操作需双人复核（PM+Admin）。
- TLS：对外统一 HTTPS；内网服务间可使用 mTLS（可选）。
- 速率限制：
  - 按用户/按端点配额；命中返回 `429`。
  - 响应头标准化：`X-RateLimit-Limit`、`X-RateLimit-Remaining`、`X-RateLimit-Reset`（UTC 秒级时间戳）。

### 5.6 PIT 快照与时间旅行（asOf）

- `asOf` 为业务日口径，默认等于当前交易日；查询附 `?asOf=YYYY-MM-DD`。
- 响应头 `X-Snapshot-Ts` 为生成快照的真实时间戳（ISO-8601）。
- 快照不可破坏：历史版本只增不改；纠错以“更正记录”追加并挂接审计链。

### 5.7 幂等性与请求跟踪

- 幂等键：同一 `Idempotency-Key`+端点+主体在 24h 窗口视为同一操作；重复提交返回相同结果或 `409`。
- 追踪：`X-Request-ID` 首跳生成并贯穿；OpenTelemetry TraceID 关联日志与指标。

------

## 6. 事件与告警规则（节流优先级、趋势确认、回撤锁存）

### 6.1 类型与阈值

- event：最小间隔 60 分钟，聚合窗口 15 分钟。
- kpi：最小间隔 24 小时，聚合窗口 60 分钟。
- trend：仅“收盘后”确认双均线交叉，最小间隔 5 个交易日。
- drawdown：`latch` 锁存；恢复条件为“最大回撤回阈值以内并连续 3 个交易日满足，或创出本轮新高”。

### 6.2 节流优先级声明（专家终审要求）

- 配置项 `alerts.throttle.by_type` 的每类配置优先于全局 `min_interval_minutes`。当两者同时存在时，以 `by_type` 为准；仅当 `by_type` 缺失时回退到全局值。

### 6.3 升级与通知

- 升级路径：P3 连续 3 次 → P2；P2 连续 2 次 → P1。
- P1 通知：IM + 邮件 + 短信，30 分钟内需确认（SLA）。
- 未确认自动升级（新增）：若 P1 在 30 分钟内未确认，则自动升级至值守 on-call（电话外呼 + 值守群 @所有人），并记录 SLA 违约事件。

### 6.4 前端呈现与观测

- 告警列表列出“距下次可触发”“锁存状态（drawdown）”“趋势确认来源（EOD）”。
- 指标：
  - `alert_throttle_hit_ratio{type}`（节流命中率）
  - `alerts_fired_total{type}`（每类触发数）
  - 告警处理时延分布（P50/P90/P99）

### 6.5 配置示例

```yaml
alerts:
  throttle:
    # 全局回退（兼容）；若 by_type 存在则以 by_type 为准
    min_interval_minutes: 120
    aggregation_window_minutes: 15
    by_type:
      event:    { min_interval_minutes: 60,   aggregation_window_minutes: 15 }
      kpi:      { min_interval_minutes: 1440, aggregation_window_minutes: 60 }
      trend:    { confirm_on_cross_rule: true, min_interval_days: 5 }
      drawdown: { latch: true }
  escalation: { p3_to_p2_hits: 3, p2_to_p1_hits: 2 }
```

------

## 7. 配置与参数（Config Store 与默认值）

### 7.1 载体与校验

- 配置载体：`config/config.yaml` + `config/overrides.yaml`（按环境覆盖）。
- 校验与回滚：包含 `configVersion` 与签名；加载失败自动回滚上一版本；关键红线参数进入 CI“配置对比器”（变更即失败）。

### 7.2 默认与优先级

- 应用默认：
  - `app.timezone: "Asia/Shanghai"`，`app.currencyDefault: "CNY"`。
- 节流优先级：`alerts.throttle.by_type` 高于全局（见 §6.2）。
- 环境优先级：`overrides.yaml` > 环境变量 > `config.yaml`。

### 7.3 默认配置片段（权威，可直接入库）

```yaml
app:
  timezone: "Asia/Shanghai"
  currencyDefault: "CNY"

scoring:
  industry: { thresholds: { in_pool: 70, core_candidate: 75 } }
  equity:   { thresholds: { observe: 65, build: 70 } }

gates:
  valuation: { window_years: 5, percentile_max: 0.7, growth_percentile_max: 0.8, peg_max: 1.5 }
  execution: { above_200dma: true }

liquidity:
  participation_rate: { A: 0.10, H: 0.08 }
  exit_days: { core: 5, tactical: 3 }
  floors:
    A: { adv20_min: 30000000, turnover_min: 0.005 }
    H: { adv20_min: 20000000, turnover_min: 0.003 }
  free_float_cap_pct_max: 0.02

portfolio:
  tiers: { A: [0.12, 0.15], B: [0.08, 0.10], C: [0.03, 0.05] }
  leverage_max: 1.10
  circuit_breaker:
    levels:
      - { drawdown: -0.10, actions: [remove_leverage, pause_tactical] }
      - { drawdown: -0.20, actions: [halve_tactical, clear_watch, tighten_entry] }
      - { drawdown: -0.30, actions: [keep_top2_3, cash_rest] }

alerts:
  throttle:
    min_interval_minutes: 120
    aggregation_window_minutes: 15
    by_type:
      event:    { min_interval_minutes: 60,   aggregation_window_minutes: 15 }
      kpi:      { min_interval_minutes: 1440, aggregation_window_minutes: 60 }
      trend:    { confirm_on_cross_rule: true, min_interval_days: 5 }
      drawdown: { latch: true }
  escalation: { p3_to_p2_hits: 3, p2_to_p1_hits: 2 }

audit:
  immutable: true
  retention_days: { hot: 90, warm: 365, cold: 1825 }
  hash_algo: "SHA-256"

evidence:
  storage:
    lifecycle: { hot_days: 180, cold_days: 1825 }
    versioning: true
```

------

## 8. 合规与安全

### 8.1 出网与白名单

- 统一代理与 `User-Agent`（含公司/合规标识），遵循 `robots.txt` 与对方站点速率限制。
- 白名单站点可配置；证据项保存 `URL/抓取时间戳/内容哈希(SHA-256)`。

### 8.2 RBAC 与审批流

- 角色：`analyst | pm | compliance | admin`；敏感参数修改需双人复核（PM+Admin）。
- 审计：`payloadHash + prevHash` 形成不可破坏链，日终导出 Merkle 根，`/audit/proof` 提供校验材料。

### 8.3 证据生命周期与数据安全

- MinIO 生命周期策略：热存 180 天、冷存 5 年（1825 天），对象版本化开启；删除需合规审批。
- 文件白名单、大小限制与杀毒（clamav）；PII/敏感字段日志脱敏；最小权限凭据分离。

------

## 9. 非功能与运维（SLO、观测、备份、发布）

### 9.1 性能与可靠性 SLO

- Score API P99 ≤ 200ms；100 标的组合构建 ≤ 2s。
- 业务时段可用性 ≥ 99.5%；失败重试指数退避（100ms×5）。

### 9.2 观测指标（Prometheus）

- 业务：`score_requests_total`, `score_request_duration_seconds{quantile}`, `portfolio_construct_duration_seconds`。
- 批处理：`eod_job_duration_seconds`, `eod_job_end_timestamp`；EOD 完成 KPI：T+30 分钟内 95 分位。
- 告警：`alerts_fired_total{type}`, `alert_throttle_hit_ratio{type}`, `alert_handling_latency_seconds`。
- 基础：`db_tps`, `redis_hit_ratio`, `queue_lag_seconds`, `disk_free_bytes`。

### 9.3 备份与恢复

- DB：每日全量 + WAL 增量（≤5 分钟），RPO ≤ 15 分钟，RTO ≤ 1 小时；季度演练。
- MinIO：每日快照；证据版本化；清单与校验和定期核验。

### 9.4 发布与回滚

- Docker Compose 环境划分：dev/stage/prod；短维护窗，DB 迁移对测。
- 快速回滚：上一版本镜像与配置保留；一键切回。
- Edge 特化：断电恢复测试、幂等重放验证、资源限额与长期运行稳定性测试。

### 9.5 CI“配置对比器”

- 对红线参数（参与率、估值阈值、PEG、200DMA、告警节流等）启用“变更即失败”，防止配置漂移。

### 9.6 告警路由与阈值（新增）

- EOD 超时：EOD 完成时间超过 T+30 分钟（95 分位目标）→ 触发 P2 告警。
- 节流命中率偏态：`alert_throttle_hit_ratio{type} < 0.10` 或 `> 0.90` 持续 30 分钟 → 触发 P3 告警（用于发现配置异常或信号风暴）。
- 路由示例：P2 → 值班负责人与后端 on-call；P3 → 产品与运维频道（工作时段）。

------

## 10. UAT 计划与测试用例（Edge 特化覆盖）

### 10.1 场景用例（通过/失败即判定）

- 场景 A：行业样板全链路
  - 证据齐备 → 评分提交/审批 → `gate/check` 通过 → `liquidity/check` 通过 → 生成建仓 → 组合看板更新
  - 断言：审计链完整；估值 NA 回退提示；容量/融资计算正确
- 场景 B：回撤断路器 (-10%)/(-20%)/(-30%)
  - 注入净值序列触发三级动作；校验 latch 锁存/恢复条件、P1 通知、仓位调整
- 场景 C：估值分位回退链
  - P/E → EV/EBITDA → EV/Sales → Z-Score；`isPartial=true` 与 `confidence` 下降
- 场景 D：类型节流与趋势确认
  - event=60m、kpi=24h、trend=收盘确认+5 个交易日间隔；drawdown 锁存与恢复
- 场景 E：H 股参与率与 Board Lot 拦截
  - 默认 `r=0.08` 回显；非整板下单被拦截并给就近数量
- 场景 F：DMA 停牌与置信度
  - 停牌 10/25 个交易日：`isStale=true`；(w_{stale}) 分别取 0.8/0.6
- 场景 G：EOD KPI
  - 正常/超时两类；EOD 完成时间超过 T+30 分钟触发 P2 告警

### 10.2 数据与工具

- 合成行情与估值样本、停牌序列、净值曲线生成器；UAT 自动化脚本覆盖关键断言。
- 固定种子与基线期望值，保证可重复性；所有 UAT 结果入库并产出报表。

------

## 11. 责任分配与里程碑（RACI 摘要）

### 11.1 责任与 Owner（节选）

- 后端（Owner）：OpenAPI v1.1.1-final 实现、节流/锁存逻辑、错误码统一
- 数据（Owner）：EOD 批（200DMA/分位）、离线数据包规范
- 前端（Owner）：告警中心与设置页增强、回显字段展示
- QA（Owner）：UAT 用例与性能压测、报告出具
- 运维（Owner）：Compose 基座、监控看板、429/锁存指标告警路由
- 合规（Owner）：白名单/UA 审核、日志留存策略

### 11.2 里程碑

- M1（T+2）：API/数据字典/配置定版（含本次终审修订）
- M2（T+4）：功能联调完成（含回显字段）
- M3（T+5）：UAT 通过与上线清单确认
- M4（+2 周）：v1.1 稳定性复盘与 v1.2 立项

### 11.3 主要风险与对策

- 配置漂移 → CI 配置对比器 + 双人复核
- 告警风暴 → 按类型节流 + 监控节流命中率
- 数据延迟 → EOD KPI + 超时告警 + 临时阈值开关（留审计）

------

## 12. 附录（提交物清单）

- formulas.md
  - 行业/个股评分公式、估值分位窗口与回退链、置信度权重、DMA 停牌口径、PEG/成长门槛
- events.md
  - 事件字段与去重键、`leadTime` 规则、来源白名单
- OpenAPI（v1.1.1-final）
  - 文件路径：`openapi/openapi-v1.1.1-final.yaml`
  - 校验命令：
    - `make openapi:validate`（建议在仓库提供目标，内部调用 `spectral lint openapi/openapi-v1.1.1-final.yaml` 或 `openapi-generator-cli validate`）
- 部署样例
  - `deploy/docker-compose.yml`（ARM64）：Caddy/Nginx、API、Postgres、Redis、MinIO、Meilisearch、Prometheus、Grafana、Loki、OTel
- 运行手册与 Runbook
  - 常见告警（EOD 超时、节流偏态、队列滞后）的处置步骤与回滚清单